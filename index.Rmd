---
title: "Death trends"
output:
  html_document:
    theme: cosmo
    mathjax: null
    self_contained: false
    toc: true
---

```{css, echo=F}
pre.r > code {white-space: pre;}
```

```{r setup, message=F}
library(CausalImpact)
library(gghighlight)
library(scales)
library(zoo)
```

```{r logic}
go <- function(deaths) {
  deaths <- na.trim(deaths)
  data <- deaths
  data$Cumulative <- ave(data,
                         format(time(data), "%Y"),
                         FUN=cumsum)
  names(data) <- c("Monthly", "Cumulative")
  data <- fortify.zoo(data, melt=T)
  data$Year <- format(data$Index, "%Y")
  data$Month <- as.numeric(format(data$Index, "%m"))
  data$Index <- NULL

  p <- function() {
    ggplot(data) +
      geom_line(aes(x=Month, y=Value, group=Year, color=Year)) +
      gghighlight(Year %in% c("2020", "2019"),
                  use_group_by=F,
                  calculate_per_facet=T) +
      facet_wrap(~Series, dir="v", scales="free_y") +
      xlab("") + ylab("Deaths") +
      scale_y_continuous(labels=scales::label_number_si()) +
      scale_x_discrete(limits=month.abb, guide=guide_axis(check.overlap=T)) +
      theme_bw(base_size=15)
  }

  print(suppressMessages(p()))

  data <- deaths
  if (any(is.na(data))) {
    message("Interpolated missing data.")
    data <- na.approx(data, na.rm=T)
  }

  tryCatch({
    pre.period <- c(start(data), as.yearmon("Dec 2019"))
    post.period <- c(as.yearmon("Jan 2020"), end(data))
    model.args <- list(niter=1000, nseasons=12)

    impact <- CausalImpact(data,
                           pre.period,
                           post.period,
                           model.args=model.args)

    print(plot(impact) +
            scale_y_continuous(labels=scales::label_number_si()) +
            ylab("Deaths"))
    cat(impact$report)
  }, error=message)
}

total <- function(deaths) {
  deaths <- na.approx(deaths)
  data <- zoo(cbind(rowSums(deaths)), time(deaths))
  names(data) <- "V1"
  go(data)
}

by.region <- function(deaths) {
  for (region in names(deaths)) {
    cat(paste("\n\n###", gsub("[.]", " ", region), "\n\n"))
    data <- subset(deaths, select=region)
    go(data)
  }
}
```

```{r data}
get.sheet.url <- function(gid) {
  paste("https://docs.google.com/spreadsheets/d/e/2PACX-1vQfgIZSsUrFzbmVK0hjbTjvY2TGI75FRkrU8rGKpLebZnfFFBCvFyI1zPgUE3uivCOmbOKOYJWyYUiQ/pub?gid=",
        gid,
        "&single=true&output=csv",
        sep="")
}

au.deaths <- read.csv.zoo(get.sheet.url("1434566235"), FUN=as.yearmon)
nz.deaths <- read.csv.zoo(get.sheet.url("894713646"), FUN=as.yearmon)
us.deaths <- read.csv.zoo(get.sheet.url("1095978846"), FUN=as.yearmon)
uk.deaths <- read.csv.zoo(get.sheet.url("0"), FUN=as.yearmon)
```

## Australia {.tabset}

```{r au, results="asis"}
total(au.deaths)
by.region(au.deaths)
```

## New Zealand {.tabset}

```{r nz, results="asis"}
total(nz.deaths)
by.region(nz.deaths)
```

## US {.tabset}

Note: I couldn't find historical data for Puerto Rico, so it's excluded from
impact analysis.

```{r us, results="asis"}
total(subset(us.deaths, select=-Puerto.Rico))
by.region(us.deaths)
```

## UK {.tabset}

```{r uk, results="asis"}
total(uk.deaths)
by.region(uk.deaths)
```
